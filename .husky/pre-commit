#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${YELLOW}ğŸ” Running pre-commit checks...${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Determine baseline for affected calculation
# Handle first commit case where HEAD~1 doesn't exist
if git rev-parse HEAD~1 >/dev/null 2>&1; then
  BASE="HEAD~1"
  echo "${BLUE}ğŸ“Š Baseline: HEAD~1 (comparing to last commit)${NC}"
else
  BASE="--all"
  echo "${BLUE}ğŸ“Š Baseline: --all (first commit detected)${NC}"
fi

# Check if there are any changes to process
if ! git diff --cached --quiet; then
  echo ""
else
  echo "${YELLOW}âš ï¸  No staged changes detected${NC}"
  exit 0
fi

# Run lint on affected projects
echo ""
echo "${YELLOW}ğŸ“ Linting affected projects...${NC}"
npx nx affected -t lint --base=$BASE
LINT_EXIT=$?
if [ $LINT_EXIT -ne 0 ]; then
  echo ""
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${RED}âŒ Lint failed!${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${YELLOW}ğŸ’¡ To fix automatically: npm run lint:fix${NC}"
  echo "${YELLOW}ğŸ’¡ To skip this check: git commit --no-verify${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  exit 1
fi

# Run typecheck on affected projects
echo ""
echo "${YELLOW}ğŸ” Type checking affected projects...${NC}"
npx nx affected -t typecheck --base=$BASE
TYPECHECK_EXIT=$?
if [ $TYPECHECK_EXIT -ne 0 ]; then
  echo ""
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${RED}âŒ Type check failed!${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${YELLOW}ğŸ’¡ Fix type errors before committing${NC}"
  echo "${YELLOW}ğŸ’¡ To skip this check: git commit --no-verify${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  exit 1
fi

# Run tests on affected projects
echo ""
echo "${YELLOW}ğŸ§ª Testing affected projects...${NC}"
npx nx affected -t test --base=$BASE
TEST_EXIT=$?
if [ $TEST_EXIT -ne 0 ]; then
  echo ""
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${RED}âŒ Tests failed!${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${YELLOW}ğŸ’¡ Fix failing tests before committing${NC}"
  echo "${YELLOW}ğŸ’¡ To skip this check: git commit --no-verify${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  exit 1
fi

echo ""
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
